<!DOCTYPE html>
<html>
<head>
    <title>Validation Progress</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            background: #1e1e1e;
            color: #fff;
            padding: 20px;
        }
        .container {
            background: #2d2d30;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        h1 {
            color: #4ec9b0;
            margin-top: 0;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #3e3e42;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ec9b0, #569cd6);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .stat-box {
            background: #3e3e42;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #4ec9b0;
        }
        .stat-label {
            color: #888;
            margin-top: 5px;
        }
        .current-param {
            background: #264f78;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Consolas', monospace;
            word-wrap: break-word;
        }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status.running { background: #4ec9b0; color: #000; }
        .status.starting { background: #569cd6; color: #000; }
        .status.complete { background: #6a9955; color: #fff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Parameter Validation Progress</h1>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar" style="width: 0%">
                <span id="progressText">0%</span>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-box">
                <div class="stat-value" id="validated">0</div>
                <div class="stat-label">Validated</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="total">844</div>
                <div class="stat-label">Total</div>
            </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
            <div>
                <strong>Status:</strong> 
                <span class="status" id="statusBadge">idle</span>
            </div>
            <div>
                <button onclick="startValidation()" style="padding: 10px 20px; margin: 0 5px; cursor: pointer; background: #4ec9b0; border: none; border-radius: 5px; font-weight: bold;">‚ñ∂Ô∏è Start</button>
                <button onclick="pauseValidation()" style="padding: 10px 20px; margin: 0 5px; cursor: pointer; background: #ce9178; border: none; border-radius: 5px; font-weight: bold;">‚è∏Ô∏è Pause</button>
                <button onclick="stopValidation()" style="padding: 10px 20px; margin: 0 5px; cursor: pointer; background: #f48771; border: none; border-radius: 5px; font-weight: bold;">‚èπÔ∏è Stop</button>
            </div>
        </div>
        
        <div class="current-param">
            <strong>Current parameter:</strong><br>
            <code id="currentParam">Waiting...</code>
        </div>
        
        <div style="margin-top: 30px;">
            <h3 style="color: #4ec9b0;">üìã Live Log</h3>
            <div id="logContainer" style="background: #1e1e1e; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 12px;">
                <div style="color: #888;">Waiting for logs...</div>
            </div>
        </div>
        
        <div style="text-align: center; color: #888; margin-top: 20px;">
            Auto-refresh every 2 seconds
        </div>
    </div>

    <script>
        let lastLogSize = 0;
        
        function updateProgress() {
            fetch('progress.json?' + new Date().getTime())
                .then(r => r.json())
                .then(data => {
                    document.getElementById('validated').textContent = data.validated;
                    document.getElementById('total').textContent = data.total;
                    document.getElementById('currentParam').textContent = data.current || 'Waiting...';
                    
                    const percent = data.percent || 0;
                    document.getElementById('progressBar').style.width = percent + '%';
                    document.getElementById('progressText').textContent = percent + '%';
                    
                    const badge = document.getElementById('statusBadge');
                    badge.textContent = data.status;
                    badge.className = 'status ' + data.status;
                    
                    // Continue if not complete
                    if (data.status === 'running' || data.status === 'starting') {
                        setTimeout(updateProgress, 2000);
                    }
                })
                .catch(e => {
                    console.error('Error:', e);
                    setTimeout(updateProgress, 5000);
                });
            
            // Update log
            updateLog();
        }
        
        function updateLog() {
            fetch('validation_log.jsonl?' + new Date().getTime())
                .then(r => r.text())
                .then(text => {
                    const lines = text.trim().split('\n').filter(l => l);
                    
                    if (lines.length > lastLogSize) {
                        const container = document.getElementById('logContainer');
                        container.innerHTML = '';
                        
                        // Show last 20 entries
                        const recent = lines.slice(-20);
                        
                        recent.forEach(line => {
                            try {
                                const entry = JSON.parse(line);
                                const div = document.createElement('div');
                                div.style.marginBottom = '10px';
                                div.style.borderLeft = '3px solid #4ec9b0';
                                div.style.paddingLeft = '10px';
                                
                                let html = `<div style="color: #4ec9b0;">${entry.parameter}</div>`;
                                html += `<div style="color: #888; font-size: 11px;">Status: ${entry.status}`;
                                
                                if (entry.notes_count > 0) {
                                    html += ` | Notes: ${entry.notes_count}`;
                                }
                                if (entry.warnings_count > 0) {
                                    html += ` | <span style="color: #f48771;">Warnings: ${entry.warnings_count}</span>`;
                                }
                                html += `</div>`;
                                
                                // Show community notes
                                if (entry.community_notes && entry.community_notes.length > 0) {
                                    entry.community_notes.forEach(note => {
                                        html += `<div style="color: #ce9178; font-size: 11px; margin-top: 3px;">`;
                                        html += `üí° [${note.source}] ${note.text.substring(0, 100)}...`;
                                        html += `</div>`;
                                    });
                                }
                                
                                // Show warnings
                                if (entry.warnings && entry.warnings.length > 0) {
                                    entry.warnings.forEach(warn => {
                                        html += `<div style="color: #f48771; font-size: 11px; margin-top: 3px;">`;
                                        html += `‚ö†Ô∏è ${warn}`;
                                        html += `</div>`;
                                    });
                                }
                                
                                div.innerHTML = html;
                                container.appendChild(div);
                            } catch (e) {
                                console.error('Parse error:', e);
                            }
                        });
                        
                        // Scroll to bottom
                        container.scrollTop = container.scrollHeight;
                        
                        lastLogSize = lines.length;
                    }
                })
                .catch(e => {
                    console.error('Log error:', e);
                });
        }
        
        function startValidation() {
            fetch('control.json', {
                method: 'POST',
                body: JSON.stringify({action: 'start'})
            }).then(() => alert('Starting validation...'));
        }
        
        function pauseValidation() {
            fetch('validation_state.json')
                .then(r => r.json())
                .then(state => {
                    state.status = 'paused';
                    // Can't write from browser - show instruction
                    alert('Validation will pause at next checkpoint.\nOr stop the process manually.');
                });
        }
        
        function stopValidation() {
            if (confirm('Stop validation? Progress will be saved.')) {
                fetch('validation_state.json')
                    .then(r => r.json())
                    .then(state => {
                        state.status = 'stop';
                        alert('Validation will stop at next checkpoint.');
                    });
            }
        }
        
        updateProgress();
        setInterval(updateLog, 2000);
    </script>
</body>
</html>

